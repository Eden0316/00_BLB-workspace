<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="productMapper">

	<resultMap id="productResultSet" type="product">
		<id column="PROD_NO" property="prodNo"/>
		<result column="CATEGORY_NAME" property="categoryName"/>
		<result column="SUBCATEGORY_NAME" property="subcategoryName"/>
		<result column="PROD_NAME" property="prodName"/>
		<result column="PROD_CONTENT" property="prodContent"/>
		<result column="PROD_PRICE" property="prodPrice"/>
		<result column="PROD_ORIGIN" property="prodOrigin"/>
		<result column="PROD_CAUTION" property="prodCaution"/>
		<result column="PROD_COUNT" property="prodCount"/>
		<result column="PROD_ENROLL_DATE" property="prodEnrollDate"/>
		<result column="PROD_STATUS" property="prodStatus"/>
		<result column="THUMB_IMG" property="thumbImg"/>
		<result column="AVG_RATING" property="avgRating"/>
		<result column="REVIEW_COUNT" property="reviewCount"/>
	</resultMap>
	
	<resultMap id="productAttResultSet" type="productAtt">
		<id column="PROD_ATT_NO" property="prodAttNo"/>
		<result column="ORIG_FILE_NAME" property="origFileName"/>
		<result column="SAVE_FILE_NAME" property="saveFileName"/>
		<result column="SAVE_PATH" property="savePath"/>
		<result column="THUMB_PATH" property="thumbPath"/>
		<result column="PROD_ATT_STATUS" property="prodAttStatus"/>
		<result column="PROD_NO" property="prodNo"/>
	</resultMap>
	
	<select id="selectProductCount" parameterType="map" 
			resultType="_int">
		SELECT COUNT(*) AS COUNT
		  FROM TB_PRODUCT
		 WHERE PROD_STATUS = 'Y'
		   AND (#{category} = '전체제품' OR CATEGORY_NAME = #{category})
		   <if test="subcategories != null and subcategories.size() > 0">
	           AND SUBCATEGORY_NAME IN
	           <foreach item="subcategory" collection="subcategories" open="(" separator="," close=")">
	               #{subcategory}
	           </foreach>
	       </if>
	       <if test="keyword != null and keyword != ''">
           AND (PROD_NAME LIKE '%' || #{keyword} || '%'
                OR PROD_CONTENT LIKE '%' || #{keyword} || '%')
       	   </if>
	</select>
	
	<select id="selectProductList" parameterType="map" 
			resultMap="productResultSet">
		SELECT P.PROD_NO
		     , P.CATEGORY_NAME
		     , P.SUBCATEGORY_NAME
		     , P.PROD_NAME
		     , P.PROD_CONTENT
		     , P.PROD_PRICE
		     , P.PROD_COUNT
		     , P.PROD_ENROLL_DATE
		     , PA.THUMB_PATH || PA.SAVE_FILE_NAME AS "THUMB_IMG"
		     , NVL(ROUND(AVG(R.REV_RATING), 1), 0) AS AVG_RATING
           	 , NVL(COUNT(R.REV_NO), 0) AS REVIEW_COUNT
		  FROM TB_PRODUCT P
		  LEFT JOIN (
		      SELECT PROD_NO, THUMB_PATH, SAVE_FILE_NAME
		        FROM TB_PRODUCT_ATTACHMENT
		       WHERE (PROD_NO, PROD_ATT_NO) IN (
		           SELECT PROD_NO, MIN(PROD_ATT_NO)
		             FROM TB_PRODUCT_ATTACHMENT
		            WHERE PROD_ATT_STATUS = 'Y'
		              AND THUMB_PATH IS NOT NULL
		            GROUP BY PROD_NO
		       )
		  ) PA
		    ON P.PROD_NO = PA.PROD_NO
		  LEFT JOIN TB_OPTION OPT ON P.PROD_NO = OPT.PROD_NO
		  LEFT JOIN TB_PRODUCT_ORDER PO ON OPT.OPT_NO = PO.OPT_NO
 		  LEFT JOIN TB_REVIEW R ON PO.SERIAL_NO = R.SERIAL_NO AND R.REV_STATUS = 'Y'
		 WHERE P.PROD_STATUS = 'Y'
		   AND (#{category} = '전체제품' OR CATEGORY_NAME = #{category})
		   <if test="subcategories != null and subcategories.size() > 0">
	           AND SUBCATEGORY_NAME IN
	           <foreach item="subcategory" collection="subcategories" open="(" separator="," close=")">
	               #{subcategory}
	           </foreach>
	       </if>
	       <if test="keyword != null and keyword != ''">
           AND (P.PROD_NAME LIKE '%' || #{keyword} || '%'
                OR P.PROD_CONTENT LIKE '%' || #{keyword} || '%')
           </if>
	     GROUP BY P.PROD_NO, P.CATEGORY_NAME, P.SUBCATEGORY_NAME, P.PROD_NAME, 
	     		  P.PROD_CONTENT, P.PROD_PRICE, P.PROD_COUNT, P.PROD_ENROLL_DATE, 
	           	  PA.THUMB_PATH, PA.SAVE_FILE_NAME
		 ORDER BY P.PROD_NO DESC
	</select>
	
	<select id="increaseViewCount" parameterType="_int">
		UPDATE TB_PRODUCT
		   SET PROD_COUNT = PROD_COUNT + 1
		 WHERE PROD_NO = #{prodNo}
		   AND PROD_STATUS = 'Y'
	</select>
	
	<select id="selectProduct" parameterType="_int"
			resultMap="productResultSet">
		SELECT PROD_NO
		     , CATEGORY_NAME
		     , SUBCATEGORY_NAME
		     , PROD_NAME
		     , PROD_CONTENT
		     , PROD_PRICE
		     , PROD_ORIGIN
		     , PROD_CAUTION
		     , PROD_COUNT
		     , PROD_ENROLL_DATE
		  FROM TB_PRODUCT
		 WHERE PROD_NO = #{prodNo}
		   AND PROD_STATUS = 'Y'
	</select>
	
	<select id="selectProductAtt" parameterType="_int"
			resultMap="productAttResultSet">
		SELECT PROD_ATT_NO
		     , ORIG_FILE_NAME
		     , SAVE_FILE_NAME
		     , SAVE_PATH
		     , THUMB_PATH
		  FROM TB_PRODUCT_ATTACHMENT
		 WHERE PROD_NO = #{prodNo}
		   AND PROD_ATT_STATUS = 'Y'
	</select>
	
	
	<!-- 구매 여부 확인 -->
	<select id="checkPurchase" parameterType="map"
			 resultType="_int">
	    SELECT COUNT(*)
	      FROM TB_PRODUCT_ORDER PO
		  JOIN TB_ORDER O ON PO.ORDER_NO = O.ORDER_NO
		  JOIN TB_OPTION OPT ON PO.OPT_NO = OPT.OPT_NO
		 WHERE O.MEMBER_ID = #{memberId}
		   AND OPT.PROD_NO = #{prodNo}
	</select>
	
	
	<!-- 1:1 문의 관련 매퍼 -->
    <!-- QnA와 답글 resultMap -->
    <resultMap id="inquiryResultMap" type="inquiry">
        <id column="INQUIRY_NO" property="inquiryNo"/>
        <result column="INQUIRY_CONTENT" property="inquiryContent"/>
   		<result column="INQUIRY_CREATE_DATE" property="inquiryCreateDate"/>
        <result column="MEMBER_ID" property="memberId"/>
        
        <!-- 답글을 리스트로 포함 -->
        <collection property="replyList" ofType="inquiryReply">
            <id column="INQUIRY_REPLY_NO" property="inquiryReplyNo"/>
            <result column="INQUIRY_REPLY_CONTENT" property="inquiryReplyContent"/>
            <result column="INQUIRY_REPLY_CREATE_DATE" property="inquiryReplyCreateDate"/>
            <result column="REPLY_MEMBER_ID" property="memberId"/>
        </collection>
    </resultMap>
	
	<select id="selectProdInquiryCount" parameterType="_int" 
			resultType="_int">
		SELECT COUNT(*)
		  FROM TB_INQUIRY
		 WHERE INQUIRY_STATUS = 'Y'
		   AND PROD_NO = #{prodNo}
	</select>
	
	<!-- QnA 목록 조회 (답글 포함) -->
    <select id="selectProdInquiryList" parameterType="_int" resultMap="inquiryResultMap">
        SELECT I.INQUIRY_NO
          	 , I.INQUIRY_CONTENT
          	 , TO_CHAR(I.INQUIRY_CREATE_DATE, 'YYYY-MM-DD HH:mm:ss') AS "INQUIRY_CREATE_DATE"
          	 , I.MEMBER_ID
          	 , R.INQUIRY_REPLY_NO
          	 , R.INQUIRY_REPLY_CONTENT
          	 , TO_CHAR(R.INQUIRY_REPLY_CREATE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS INQUIRY_REPLY_CREATE_DATE
          	 , R.MEMBER_ID AS REPLY_MEMBER_ID
        FROM TB_INQUIRY I
        LEFT JOIN TB_INQUIRY_REPLY R 
            ON I.INQUIRY_NO = R.INQUIRY_NO
            AND R.INQUIRY_REPLY_STATUS = 'Y'
        WHERE I.PROD_NO = #{prodNo} 
          AND I.INQUIRY_STATUS = 'Y'
        ORDER BY I.INQUIRY_NO DESC
    </select>
	
	
	
	<insert id="insertInquiry" parameterType="inquiry">
	    INSERT INTO TB_INQUIRY(INQUIRY_NO
	    					, INQUIRY_TYPE
	                        , INQUIRY_CONTENT
	                        , MEMBER_ID
	                        , PROD_NO)
	                   VALUES(SEQ_INQUIRY_NO.NEXTVAL
	                   		, #{inquiryType}
	                        , #{inquiryContent}
	                        , #{memberId}
	                        , <if test="prodNo == 0">null</if>
	                        <if test="prodNo != 0">#{prodNo}</if>)
	</insert>
	
	<update id="deleteInquiry" parameterType="_int">
		UPDATE TB_INQUIRY
		   SET INQUIRY_STATUS = 'N'
		 WHERE INQUIRY_NO = #{inquiryNo}
	</update>
	
	<update id="updateInquiry" parameterType="inquiry">
		UPDATE TB_INQUIRY
		   SET INQUIRY_CONTENT = #{inquiryContent}
		     , INQUIRY_CREATE_DATE = SYSDATE
		 WHERE INQUIRY_NO = #{inquiryNo}
		   AND INQUIRY_STATUS = 'Y'
	</update>
	
</mapper>
